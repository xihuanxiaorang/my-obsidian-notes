---
tags:
  - Java/DesignPattern
create_time: 2025-06-14 19:25
update_time: 2025/06/20 19:06
priority: 1
---

## å®šä¹‰

å•ä¾‹æ¨¡å¼ï¼ˆSingletonï¼‰æ˜¯ä¸€ç§<mark style="background: #ABF7F7A6;">åˆ›å»ºå‹</mark>è®¾è®¡æ¨¡å¼ï¼Œæ—¨åœ¨ä¿è¯**ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹**ï¼Œå¹¶**æä¾›ä¸€ä¸ªè®¿é—®è¯¥å®ä¾‹çš„å…¨å±€è®¿é—®ç‚¹**ã€‚
![](https://img.xiaorang.fun/202506142338281.png)

## ç±»å›¾

```plantuml
@startuml

class Singleton {
  - {static} INSTANCE: Singleton
  - Singleton()
  + {static} getInstance(): Singleton
}

@enduml
```

## å®ç°æ–¹å¼

- **é™æ€æˆå‘˜å˜é‡**ï¼šå®šä¹‰ä¸€ä¸ªç§æœ‰çš„é™æ€æˆå‘˜å˜é‡ `INSTANCE`ï¼ˆç±»å‹ä¸º `Singleton`ï¼‰ï¼Œç”¨äºå­˜å‚¨è¯¥ç±»çš„å”¯ä¸€å®ä¾‹ã€‚
- **ç§æœ‰æ„é€ æ–¹æ³•**ï¼šå°†æ„é€ æ–¹æ³•ç§æœ‰åŒ–ï¼Œé˜²æ­¢å¤–éƒ¨ä½¿ç”¨ `new` æ“ä½œç¬¦ç›´æ¥åˆ›å»ºå¯¹è±¡å®ä¾‹ã€‚
- **å…¨å±€è®¿é—®ç‚¹**ï¼šæä¾›ä¸€ä¸ªé™æ€æ–¹æ³• `getInstance()` ä½œä¸ºå…¨å±€è®¿é—®ç‚¹ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›å­˜å‚¨åœ¨ `INSTANCE` ä¸­çš„å•ä¾‹å¯¹è±¡ã€‚

| å®ç°æ–¹å¼       | çº¿ç¨‹å®‰å…¨ | é˜²åå°„ | é˜²åºåˆ—åŒ– | å»¶è¿ŸåŠ è½½ | ç®€æ´æ€§ | æ¨èç¨‹åº¦        |
| ---------- | ---- | --- | ---- | ---- | --- | ----------- |
| [[#é¥¿æ±‰å¼]]   | âœ…    | âŒ   | âŒ    | âŒ    | ç®€å•  | â­â­          |
| [[#æ‡’æ±‰å¼]]   | âŒ    | âŒ   | âŒ    | âœ…    | ä¸€èˆ¬  | â­           |
| [[#åŒé‡æ£€æŸ¥é”]] | âœ…    | âŒ   | âŒ    | âœ…    | ä¸€èˆ¬  | â­â­          |
| [[#é™æ€å†…éƒ¨ç±»]] | âœ…    | âŒ   | âŒ    | âœ…    | ç®€æ´  | â­â­â­         |
| [[#æšä¸¾å•ä¾‹]]  | âœ…    | âœ…   | âœ…    | âŒ    | æœ€ç®€æ´ | â­â­â­â­ âœ… å¼ºçƒˆæ¨è |

### é¥¿æ±‰å¼

- ç‰¹ç‚¹ï¼š**ç±»åŠ è½½æ—¶**å³åˆ›å»ºå®ä¾‹ï¼Œ**çº¿ç¨‹å®‰å…¨**ä½†**æ— æ³•å»¶è¿ŸåŠ è½½**ã€‚
- ä¼˜ç¼ºç‚¹ï¼š
	- âœ… **ä¼˜ç‚¹**ï¼šæ— é”é«˜æ•ˆï¼Œæ€§èƒ½ä¼˜äº[[#æ‡’æ±‰å¼]]ï¼›
	- âŒ **ç¼ºç‚¹**ï¼šå¯èƒ½æµªè´¹å†…å­˜ï¼ˆæœªä½¿ç”¨å³åˆ›å»ºï¼‰ã€‚

```java hl:2,4-5,7-9
public class HungrySingleton {  
  private static final HungrySingleton INSTANCE = new HungrySingleton();  
  
  private HungrySingleton() {
  }  
  
  public static HungrySingleton getInstance() {  
    return INSTANCE;  
  }  
}
```

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼š

- **ç§æœ‰æ„é€ æ–¹æ³•**ç¦æ­¢å¤–éƒ¨ç›´æ¥åˆ›å»ºå¯¹è±¡ï¼Œç¡®ä¿å¤–éƒ¨æ— æ³•å®ä¾‹åŒ–ï¼›
- é™æ€å¸¸é‡ `INSTANCE` åœ¨**ç±»åŠ è½½æ—¶åˆå§‹åŒ–ä¸€æ¬¡**ï¼Œä¿è¯å®ä¾‹å”¯ä¸€ä¸”ä¸å¯å˜ï¼›
- æä¾›é™æ€æ–¹æ³• `getInstance()` ä½œä¸º**å…¨å±€è®¿é—®ç‚¹**ï¼Œå¯¹å¤–æš´éœ²å•ä¾‹å¯¹è±¡ã€‚

### æ‡’æ±‰å¼

é¦–æ¬¡è°ƒç”¨ `getInstance()` æ–¹æ³•æ—¶æ‰ä¼šåˆ›å»ºå®ä¾‹ï¼Œå…·å¤‡**å»¶è¿ŸåŠ è½½**ç‰¹æ€§ï¼Œä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹**ä¸å®‰å…¨**ã€‚

```java hl:2,4-5,7-12
public class LazySingleton {  
  private static LazySingleton INSTANCE;  
  
  private LazySingleton() {  
  }  
  
  public static LazySingleton getInstance() {  
    if (INSTANCE == null) {  
      INSTANCE = new LazySingleton();  
    }  
    return INSTANCE;  
  }  
}
```

æµ‹è¯•æ–¹æ³•ï¼š

```java
@Test  
public void testLazySingleton() {  
	Runnable runnable = () -> {  
		LazySingleton instance = LazySingleton.getInstance();  
		LOGGER.info("{}ï¼š{}", Thread.currentThread().getName(), instance);  
	};  
	Thread t1 = new Thread(runnable);  
	Thread t2 = new Thread(runnable);  
	t1.start();  
	t2.start();  
}  
```

æµ‹è¯•ç»“æœï¼š

```
23:00:20.943 [Thread-0] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- Thread-0ï¼šfun.xiaorang.study.designpattern.singleton.LazySingleton@4e54ffd6
23:00:20.943 [Thread-1] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- Thread-1ï¼šfun.xiaorang.study.designpattern.singleton.LazySingleton@6d2b14bd
```

ğŸ’¥ ä¸¤ä¸ªçº¿ç¨‹è·å–çš„å®ä¾‹åœ°å€ä¸åŒï¼Œè¯´æ˜è¯¥å®ç°**çº¿ç¨‹ä¸å®‰å…¨**ï¼Œå¯èƒ½åˆ›å»ºå¤šä¸ªå®ä¾‹ï¼Œç ´åå•ä¾‹çº¦æŸã€‚

### åŒé‡æ£€æŸ¥é”

é‰´äºå‰é¢æåˆ°çš„[[#æ‡’æ±‰å¼]]å•ä¾‹æ¨¡å¼åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¸å®‰å…¨ï¼Œæœ€ç›´æ¥çš„æ”¹è¿›æ–¹å¼æ˜¯ï¼šä¸º `getInstance()` æ·»åŠ  **`synchronized`** å…³é”®å­—ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ï¼š

```java hl:2,4-5,7-12
public class LazySingleton {  
  private static LazySingleton INSTANCE;  
  
  private LazySingleton() {  
  }  
  
  public synchronized static LazySingleton getInstance() {  
    if (INSTANCE == null) {  
      INSTANCE = new LazySingleton();  
    }  
    return INSTANCE;  
  }  
}
```

æµ‹è¯•æ–¹æ³•ï¼š

```java
@Test  
public void testLazySyncSingleton() {  
  Runnable runnable = () -> {  
    LazySyncSingleton instance = LazySyncSingleton.getInstance();  
    LOGGER.info("{}ï¼š{}", Thread.currentThread().getName(), instance);  
  };  
  Thread t1 = new Thread(runnable);  
  Thread t2 = new Thread(runnable);  
  t1.start();  
  t2.start();  
}
```

è¿è¡Œæ—¶æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼šå½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ `getInstance()` æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¼šè¢«é˜»å¡ï¼ˆçŠ¶æ€å˜ä¸º `MONITOR`ï¼‰ï¼Œç›´è‡³å‰è€…å®Œæˆã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
![](https://img.xiaorang.fun/202506171849698.png)

æµ‹è¯•ç»“æœï¼š

```
23:14:33.471 [Thread-0] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- Thread-0ï¼šfun.xiaorang.study.designpattern.singleton.LazySyncSingleton@8b43eba
23:14:33.471 [Thread-1] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- Thread-1ï¼šfun.xiaorang.study.designpattern.singleton.LazySyncSingleton@8b43eba
```

å°½ç®¡ä¸Šè¿°åšæ³•è§£å†³äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä½†**æ¯æ¬¡è®¿é—®éƒ½è¦åŠ é”ï¼Œé‡Šæ”¾ï¼Œå¼€é”€è¾ƒå¤§ï¼Œæ€§èƒ½è¾ƒå·®**ã€‚é‚£æœ‰æ²¡æœ‰æ›´ä¼˜è§£å‘¢ï¼Ÿ
ğŸš€æ¨èæ–¹æ¡ˆï¼šä½¿ç”¨**åŒé‡æ£€æŸ¥é”ï¼ˆDouble-Checked Lockingï¼ŒDCLï¼‰ä¼˜åŒ–åŒæ­¥èŒƒå›´ï¼Œä»…åœ¨é¦–æ¬¡åˆ›å»ºå®ä¾‹æ—¶åŠ é”**ï¼Œå…¼é¡¾å®‰å…¨ä¸æ€§èƒ½ï¼š

```java hl:2,4-5,7-16
public class LazyDoubleCheckSingleton {  
  private static volatile LazyDoubleCheckSingleton INSTANCE;  
  
  private LazyDoubleCheckSingleton() {  
  }  
  
  public static LazyDoubleCheckSingleton getInstance() {  
    if (INSTANCE == null) {  
      synchronized (LazyDoubleCheckSingleton.class) {  
        if (INSTANCE == null) {  
          INSTANCE = new LazyDoubleCheckSingleton();  
        }  
      }  
    }  
    return INSTANCE;  
  }  
}
```

> [!tip] å…³é”®ç‚¹
> **`INSTANCE` å¿…é¡»ä½¿ç”¨ `volatile` ä¿®é¥°ï¼Œé˜²æ­¢<mark style="background: #FFB8EBA6;">æŒ‡ä»¤é‡æ’</mark>å¯¼è‡´å¯¹è±¡æœªå®Œå…¨æ„é€ å°±è¢«å…¶ä»–çº¿ç¨‹è¯»å–**ã€‚

æµ‹è¯•æ–¹æ³•ï¼š

```java
@Test  
public void testLazyDoubleCheckSingleton() {  
  Runnable runnable = () -> {  
    LazyDoubleCheckSingleton instance = LazyDoubleCheckSingleton.getInstance();  
    LOGGER.info("{}ï¼š{}", Thread.currentThread().getName(), instance);  
  };  
  Thread t1 = new Thread(runnable);  
  Thread t2 = new Thread(runnable);  
  t1.start();  
  t2.start();  
}
```

æµ‹è¯•ç»“æœï¼š

```
13:03:39.795 [Thread-0] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- Thread-0ï¼šfun.xiaorang.study.designpattern.singleton.LazyDoubleCheckSingleton@58f08ea5
13:03:39.795 [Thread-1] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- Thread-1ï¼šfun.xiaorang.study.designpattern.singleton.LazyDoubleCheckSingleton@58f08ea5
```

âœ… æ— è®ºè¿è¡Œå¤šå°‘æ¬¡ï¼Œ**å¤šçº¿ç¨‹ä¸‹å§‹ç»ˆè¿”å›åŒä¸€ä¸ªå®ä¾‹ï¼Œçº¿ç¨‹å®‰å…¨**ã€‚

> [!note]
> è™½ç„¶ DCL æ€§èƒ½è¾ƒå¥½ï¼Œä½†ä»£ç ç›¸å¯¹å¤æ‚ï¼Œ`volatile` ä¹Ÿä¼šé™åˆ¶éƒ¨åˆ† JVM ä¼˜åŒ–ã€‚**æ›´æ¨èä½¿ç”¨[[#é™æ€å†…éƒ¨ç±»]]æˆ–[[#æšä¸¾å•ä¾‹]]æ–¹æ¡ˆã€‚**

### é™æ€å†…éƒ¨ç±»

é™æ€å†…éƒ¨ç±»å®ç°æ–¹å¼æ—¢è§£å†³äº†[[#é¥¿æ±‰å¼]]çš„**èµ„æºæµªè´¹é—®é¢˜**ï¼Œä¹Ÿé¿å…äº†[[#åŒé‡æ£€æŸ¥é”]]çš„**åŒæ­¥å¼€é”€**ï¼Œè¢«è®¤ä¸ºæ˜¯æ‡’åŠ è½½å•ä¾‹çš„æœ€ä½³å®è·µä¹‹ä¸€ã€‚

å…¶æ ¸å¿ƒåŸç†ï¼š

1. **é™æ€å†…éƒ¨ç±»ä¸ä¼šéšç€å¤–éƒ¨ç±»åŠ è½½è€Œåˆå§‹åŒ–**ï¼Œåªæœ‰åœ¨é¦–æ¬¡è°ƒç”¨ `getInstance()` æ—¶æ‰ä¼šè§¦å‘åŠ è½½ï¼›
2. å†…éƒ¨ç±»ä¸­çš„é™æ€å˜é‡åœ¨**ç±»åŠ è½½æ—¶æ‰ä¼šåˆå§‹åŒ–ä¸€æ¬¡ï¼Œå¹¶ç”± JVM ä¿è¯çº¿ç¨‹å®‰å…¨**ã€‚

å› æ­¤å®ƒ**å¤©ç„¶æ”¯æŒæ‡’åŠ è½½**ï¼Œä¸”**æ— éœ€æ˜¾å¼åŠ é”å°±èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨**ã€‚

```java hl:2-3,5-7,9-11
public class LazyStaticInnerSingleton {  
  private LazyStaticInnerSingleton() {  
  }  
  
  public static LazyStaticInnerSingleton getInstance() {  
    return SingletonHolder.INSTANCE;  
  }  
  
  private static class SingletonHolder {  
    private static final LazyStaticInnerSingleton INSTANCE = new LazyStaticInnerSingleton();  
  }  
}
```

è¯¥å®ç°æ–¹å¼ç»“åˆäº†**å»¶è¿ŸåŠ è½½**ä¸**çº¿ç¨‹å®‰å…¨**çš„ä¼˜ç‚¹ï¼Œç»“æ„æ¸…æ™°ã€æ‰§è¡Œé«˜æ•ˆï¼Œæ˜¯å®ç°å•ä¾‹æ¨¡å¼çš„ä¼˜é€‰æ–¹æ¡ˆä¹‹ä¸€ã€‚

### æšä¸¾å•ä¾‹

åœ¨ã€ŠEffective Javaã€‹ç¬¬äºŒç‰ˆç¬¬ 3 æ¡ä¸­ï¼Œä½œè€… **Joshua Bloch** å¼ºè°ƒï¼š

> **"A single-element enum type is the best way to implement a singleton."**

```java
public enum EnumSingleton {  
	INSTANCE  
}
```

æµ‹è¯•æ–¹æ³•ï¼š

```java
@Test  
public void testEnumSingleton() {  
  Runnable runnable = () -> {  
    EnumSingleton instance = EnumSingleton.INSTANCE;  
    LOGGER.info("{}ï¼š{}", Thread.currentThread().getName(), instance);  
  };  
  Thread t1 = new Thread(runnable);  
  Thread t2 = new Thread(runnable);  
  t1.start();  
  t2.start();  
}
```

æµ‹è¯•ç»“æœï¼š

```
16:35:40.756 [Thread-0] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- Thread-0ï¼šINSTANCE
16:35:40.757 [Thread-1] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- Thread-1ï¼šINSTANCE
```

ç›¸æ¯”ä¼ ç»Ÿçš„[[#é¥¿æ±‰å¼]]ã€[[#æ‡’æ±‰å¼]]ã€[[#åŒé‡æ£€æŸ¥é”]]ç­‰å®ç°æ–¹å¼ï¼Œæšä¸¾å•ä¾‹å…·å¤‡ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- **ç®€æ´ä¼˜é›…**ï¼šæ— éœ€æ˜¾ç¤ºæ„é€ ã€åŒæ­¥æ§åˆ¶æˆ–æ‡’åŠ è½½é€»è¾‘ï¼›
- **çº¿ç¨‹å®‰å…¨**ï¼šJVM ä¿è¯æšä¸¾ç±»åœ¨åŠ è½½æ—¶åªåˆå§‹åŒ–ä¸€æ¬¡ï¼›
- **[[#å¤©ç„¶é˜²åå°„æ”»å‡»]]**ï¼šæ— æ³•é€šè¿‡åå°„å®ä¾‹åŒ–ï¼›
- **[[#å¤©ç„¶é˜²åºåˆ—åŒ–ç ´å]]**ï¼šååºåˆ—åŒ–å§‹ç»ˆè¿”å›åŒä¸€å®ä¾‹ï¼›

ğŸš€æšä¸¾å•ä¾‹æœ¬è´¨ä¸Šå±äº[[#é¥¿æ±‰å¼]]å®ç°ï¼Œ**å¦‚æœä¸éœ€è¦å»¶è¿ŸåŠ è½½ï¼Œå®ƒæ˜¯æœ€å®‰å…¨ã€æœ€æ¨èçš„å®ç°æ–¹å¼ã€‚

## å­˜åœ¨çš„é—®é¢˜

é™¤[[#æšä¸¾å•ä¾‹]]å¤–çš„å…¶ä»–å•ä¾‹å®ç°æ–¹å¼ï¼ˆå¦‚[[#é¥¿æ±‰å¼]]ã€[[#æ‡’æ±‰å¼]]ã€[[#åŒé‡æ£€æŸ¥é”]]ã€[[#é™æ€å†…éƒ¨ç±»]]ï¼‰éƒ½å­˜åœ¨è¢«**åå°„**æˆ–**ååºåˆ—åŒ–**ç ´åçš„é£é™©ï¼Œä»è€Œåˆ›å»ºå¤šä¸ªå®ä¾‹ï¼Œå¯¼è‡´å•ä¾‹å¤±æ•ˆã€‚

### åå°„ç ´åå•ä¾‹æ¨¡å¼

#### é—®é¢˜å¤ç°

```java
@Test  
public void testReflectDestroyLazyStaticInnerSingleton() throws NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException {  
  Class<LazyStaticInnerSingleton> clazz = LazyStaticInnerSingleton.class;  
  // é€šè¿‡åå°„çš„æ–¹å¼è·å–ç§æœ‰æ„é€ æ–¹æ³•  
  final Constructor<LazyStaticInnerSingleton> constructor = clazz.getDeclaredConstructor();  
  // å¼ºåˆ¶è®¿é—®  
  constructor.setAccessible(true);  
  // åˆ›å»ºå¯¹è±¡  
  final LazyStaticInnerSingleton o1 = constructor.newInstance();  
  LOGGER.info("{}", o1);  
  final LazyStaticInnerSingleton o2 = constructor.newInstance();  
  LOGGER.info("{}", o2);  
  // åˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœè¾“å‡ºçš„ç»“æœä¸º falseï¼Œåˆ™è¯´æ˜ä¸¤ä¸ªå¯¹è±¡ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œä»è€Œè¯´æ˜å¯ä»¥é€šè¿‡åå°„ç ´åå•ä¾‹æ¨¡å¼  
  LOGGER.info("{}", o1 == o2);  
}
```

æµ‹è¯•ç»“æœï¼š

``` hl:3
13:25:26.005 [main] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- instance1: fun.xiaorang.study.designpattern.singleton.LazyStaticInnerSingleton@35e2d654
13:25:26.009 [main] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- instance2: fun.xiaorang.study.designpattern.singleton.LazyStaticInnerSingleton@4c371370
13:25:26.010 [main] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- æ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡: false
```

> [!note]
> é€šè¿‡åå°„è°ƒç”¨ç§æœ‰æ„é€ å™¨ï¼Œå¯ç»•è¿‡è®¿é—®é™åˆ¶ï¼Œåˆ›å»ºå¤šä¸ªå¯¹è±¡ï¼Œä»è€Œç ´åå•ä¾‹çº¦æŸã€‚

#### è§£å†³æ–¹æ¡ˆ

å¯åœ¨æ„é€ æ–¹æ³•ä¸­åŠ å…¥é˜²å¾¡é€»è¾‘ï¼šè‹¥å®ä¾‹å·²åˆ›å»ºï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸é˜»æ­¢é‡å¤åˆ›å»ºã€‚

```java hl:2,5-8
public class LazyStaticInnerSingleton {  
  private static boolean initialized = false;  

  private LazyStaticInnerSingleton() {  
    if (initialized) {  
      throw new RuntimeException("å•ä¾‹å¯¹è±¡ç¦æ­¢é‡å¤åˆ›å»º");  
    }  
    initialized = true;  
  }  

  public static LazyStaticInnerSingleton getInstance() {  
    return SingletonHolder.INSTANCE;  
  }  

  private static class SingletonHolder {  
    private static final LazyStaticInnerSingleton INSTANCE = new LazyStaticInnerSingleton();  
  }  
}
```

å†æ¬¡è¿è¡Œæµ‹è¯•ï¼š

```
Exception in thread "main" java.lang.RuntimeException: å•ä¾‹å¯¹è±¡ç¦æ­¢é‡å¤åˆ›å»º
```

> [!note]
> æ­¤æ–¹å¼å¯é˜²æ­¢å¤šæ•°åå°„æ”»å‡»ï¼Œä½†ä»å¯èƒ½è¢«å­—èŠ‚ç ç¯¡æ”¹ã€`Unsafe`ã€æˆ– `AccessibleObject` ç­‰æ‰‹æ®µç»•è¿‡ã€‚

### åºåˆ—åŒ–ç ´åå•ä¾‹æ¨¡å¼

å³ä¾¿é˜²ä½äº†åå°„æ”»å‡»ï¼Œ**ååºåˆ—åŒ–**ä¹Ÿå¯èƒ½ç»•è¿‡æ„é€ æ–¹æ³•ï¼Œç ´åå•ä¾‹çº¦æŸã€‚

#### é—®é¢˜å¤ç°

> [!note]
> åœ¨æµ‹è¯•å‰éœ€è®©ç±»å®ç° `Serializable` æ¥å£ï¼Œå¦åˆ™ä¼šæŠ›å‡º `NotSerializableException` å¼‚å¸¸ã€‚

```java
@Test
public void testDeserializeDestroyLazyStaticInnerSingleton() throws Exception {
  LazyStaticInnerSingleton instance1 = LazyStaticInnerSingleton.getInstance();
  try (ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream("singleton.obj"))) {
    oos.writeObject(instance1);
  }

  try (ObjectInputStream ois = new ObjectInputStream(new FileInputStream("singleton.obj"))) {
    LazyStaticInnerSingleton instance2 = (LazyStaticInnerSingleton) ois.readObject();
    LOGGER.info("instance1: {}", instance1);
    LOGGER.info("instance2: {}", instance2);
    LOGGER.info("æ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡: {}", instance1 == instance2); // falseï¼Œè¯´æ˜è¢«ç ´å
  }
}
```

æµ‹è¯•ç»“æœï¼š

``` hl:3
12:34:08.297 [main] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- instance1: fun.xiaorang.study.designpattern.singleton.LazyStaticInnerSingleton@411f53a0
12:34:08.301 [main] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- instance2: fun.xiaorang.study.designpattern.singleton.LazyStaticInnerSingleton@7e6f74c
12:34:08.301 [main] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- æ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡: false
```

#### è§£å†³æ–¹æ¡ˆ

å¯é€šè¿‡å®ç° `readResolve()` æ–¹æ³•ï¼Œåœ¨ååºåˆ—åŒ–æ—¶è¿”å›å·²æœ‰å®ä¾‹ï¼Œé¿å…æ–°å¯¹è±¡åˆ›å»ºï¼š

```java
private Object readResolve() throws ObjectStreamException {
  return getInstance();
}
```

å®Œæ•´ç¤ºä¾‹ï¼š

```java hl:1,15-17
public class LazyStaticInnerSingleton implements Serializable {  
  private static boolean initialized = false;  
  
  private LazyStaticInnerSingleton() {  
    if (initialized) {  
      throw new RuntimeException("å•ä¾‹å¯¹è±¡ç¦æ­¢é‡å¤åˆ›å»º");  
    }  
    initialized = true;  
  }  
  
  private Object readResolve() {  
    return getInstance();  
  }  
  
  public static LazyStaticInnerSingleton getInstance() {  
    return SingletonHolder.INSTANCE;  
  }  
  
  private static class SingletonHolder {  
    private static final LazyStaticInnerSingleton INSTANCE = new LazyStaticInnerSingleton();  
  }  
}
```

æµ‹è¯•ç»“æœï¼š

``` hl:3
12:38:21.515 [main] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- instance1: fun.xiaorang.study.designpattern.singleton.LazyStaticInnerSingleton@57a3af25
12:38:21.519 [main] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- instance2: fun.xiaorang.study.designpattern.singleton.LazyStaticInnerSingleton@57a3af25
12:38:21.519 [main] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- æ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡: true
```

## æ‰©å±•

### JDK ä¸­çš„å•ä¾‹å®ç°

JDK ä¸­çš„ `java.lang.Runtime` ç±»å°±æ˜¯å…¸å‹çš„[[#é¥¿æ±‰å¼]]å•ä¾‹æ¨¡å¼ï¼š

```java
public class Runtime {  
  private static final Runtime currentRuntime = new Runtime();

  public static Runtime getRuntime() {  
    return currentRuntime;  
  }

  private Runtime() {}
}
```

æ ¸å¿ƒè¦ç‚¹ï¼š

- æ„é€ å™¨ç§æœ‰åŒ–ï¼Œç¦æ­¢å¤–éƒ¨åˆ›å»ºå®ä¾‹ï¼›
- é™æ€å˜é‡ `currentRuntime` åœ¨ç±»åŠ è½½æ—¶åˆå§‹åŒ–ï¼Œç¡®ä¿å”¯ä¸€ï¼›
- æä¾› `getRuntime()` æ–¹æ³•ä½œä¸ºå…¨å±€è®¿é—®ç‚¹ã€‚

è¯¥è®¾è®¡ç¡®ä¿æ•´ä¸ª JVM ç”Ÿå‘½å‘¨æœŸä¸­ `Runtime` å®ä¾‹å”¯ä¸€ï¼Œæœ‰æ•ˆé¿å…èµ„æºç«äº‰ï¼Œæå‡ç³»ç»Ÿç¨³å®šæ€§ã€‚

### ä¸ºä»€ä¹ˆæšä¸¾å•ä¾‹æ— æ³•è¢«åå°„å’Œåºåˆ—åŒ–ç ´åï¼Ÿ

#### å¤©ç„¶é˜²åå°„æ”»å‡»

å°è¯•é€šè¿‡åå°„åˆ›å»ºæšä¸¾å®ä¾‹ï¼š

```java
@Test  
public void testReflectDestroyEnumSingleton() throws NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException {  
  Class<EnumSingleton> clazz = EnumSingleton.class;  
  // é€šè¿‡åå°„çš„æ–¹å¼è·å–ç§æœ‰æ„é€ æ–¹æ³•  
  final Constructor<EnumSingleton> constructor = clazz.getDeclaredConstructor();  
  // å…³é—­è®¿é—®æ£€æŸ¥  
  constructor.setAccessible(true);  
  // åˆ›å»ºå¯¹è±¡  
  final EnumSingleton instance = constructor.newInstance();  
  LOGGER.info("instance: {}", instance);  
}
```

æµ‹è¯•ç»“æœï¼š

```
java.lang.NoSuchMethodException: fun.xiaorang.study.designpattern.singleton.EnumSingleton.<init>()
```

è¯´æ˜æšä¸¾ç±»ä¸å­˜åœ¨æ— å‚æ„é€ æ–¹æ³•ã€‚æŸ¥çœ‹å…¶çˆ¶ç±» `Enum` çš„å®é™…æ„é€ æ–¹æ³•ç­¾åå¦‚ä¸‹ï¼š

```java
protected Enum(String name, int ordinal)
```

è¿›ä¸€æ­¥è°ƒç”¨çˆ¶ç±» `Enum` çš„æ„é€ å™¨ï¼š

```java hl:5,9
@Test  
public void testReflectDestroyEnumSingleton() throws NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException {  
  Class<EnumSingleton> clazz = EnumSingleton.class;  
  // é€šè¿‡åå°„çš„æ–¹å¼è·å–ç§æœ‰æ„é€ æ–¹æ³•  
  final Constructor<EnumSingleton> constructor = clazz.getDeclaredConstructor(String.class, int.class);  
  // å…³é—­è®¿é—®æ£€æŸ¥  
  constructor.setAccessible(true);  
  // åˆ›å»ºå¯¹è±¡  
  final EnumSingleton instance = constructor.newInstance("INSTANCE", 0); // æŠ›å‡ºå¼‚å¸¸ java.lang.IllegalArgumentException: Cannot reflectively create enum constants  
  LOGGER.info("instance: {}", instance);  
}
```

æµ‹è¯•ç»“æœï¼š

```
java.lang.IllegalArgumentException: Cannot reflectively create enum objects
```

è¯´æ˜ **JDK æ˜ä»¤ç¦æ­¢é€šè¿‡åå°„åˆ›å»ºæšä¸¾å®ä¾‹**ã€‚æºç ä¸­ï¼Œ`Constructor #newInstance ()` æ–¹æ³•åŒ…å«å¦‚ä¸‹åˆ¤æ–­é€»è¾‘ï¼š
![[Pasted image 20250620172545.png]]

ğŸ”’**ç»“è®º**ï¼š**æšä¸¾å®ä¾‹çš„åˆ›å»ºç”± JVM åœ¨ç±»åŠ è½½é˜¶æ®µæ§åˆ¶ï¼Œåå°„æœºåˆ¶æ— æ³•ç»•è¿‡**ï¼Œå¤©ç„¶é˜²æ­¢åå°„ç ´åå•ä¾‹ã€‚

#### å¤©ç„¶é˜²åºåˆ—åŒ–ç ´å

å°è¯•é€šè¿‡åºåˆ—åŒ–ç ´åæšä¸¾å•ä¾‹ï¼š

```java
@Test  
public void testDeserializeDestroyEnumSingleton() throws Exception {  
  EnumSingleton instance1 = EnumSingleton.INSTANCE;  
  try (ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream("singleton.obj"))) {  
    oos.writeObject(instance1);  
  }  
  
  try (ObjectInputStream ois = new ObjectInputStream(new FileInputStream("singleton.obj"))) {  
    EnumSingleton instance2 = (EnumSingleton) ois.readObject();  
    LOGGER.info("instance1: {}", instance1);  
    LOGGER.info("instance2: {}", instance2);  
    LOGGER.info("æ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡: {}", instance1 == instance2); // falseï¼Œè¯´æ˜è¢«ç ´å  
  }  
}
```

æµ‹è¯•ç»“æœï¼š

``` hl:3
17:38:37.812 [main] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- instance1: INSTANCE
17:38:37.815 [main] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- instance2: INSTANCE
17:38:37.815 [main] INFO fun.xiaorang.study.designpattern.singleton.ApiTest -- æ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡: true
```

ğŸ§©**åŸå› **ï¼šæšä¸¾çš„ååºåˆ—åŒ–è¿‡ç¨‹ç”± JVM ç‰¹æ®Šå¤„ç†ï¼Œ**å§‹ç»ˆè¿”å›å·²æœ‰æšä¸¾å¸¸é‡ï¼Œä¸ä¼šåˆ›å»ºæ–°å®ä¾‹**ã€‚
ğŸ”’**ç»“è®º**ï¼šæšä¸¾æ— éœ€å®ç° `readResolve()` æ–¹æ³•ï¼Œå³å¯ä»åº•å±‚é¿å…ååºåˆ—åŒ–ç ´åã€‚

#### æ€»ç»“

| æ”»å‡»æ–¹å¼  | æ˜¯å¦æˆåŠŸ | é˜²æŠ¤æœºåˆ¶è¯´æ˜               |
| ----- | ---- | -------------------- |
| åå°„æ”»å‡»  | å¦    | JDK ç¦æ­¢åå°„åˆ›å»ºæšä¸¾å®ä¾‹       |
| åºåˆ—åŒ–æ”»å‡» | å¦    | JVM å¤„ç†ä¿è¯ååºåˆ—åŒ–è¿”å›åŒä¸€å¸¸é‡å®ä¾‹ |

ğŸ“Œ **[[#æšä¸¾å•ä¾‹]]æ˜¯æœ€å®‰å…¨çš„å®ç°æ–¹å¼**ï¼Œä»è¯­è¨€å±‚é¢å½»åº•è§„é¿äº†åå°„ä¸åºåˆ—åŒ–ç ´åé£é™©ï¼Œæ˜¯ã€ŠEffective Javaã€‹ä¸­å¼ºçƒˆæ¨èçš„æœ€ä½³æ–¹æ¡ˆã€‚
