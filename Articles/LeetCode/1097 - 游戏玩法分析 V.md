---
tags:
  - LeetCode
  - SQL
level: Hard
create_time: 2025/04/06 23:17
update_time: 2025/08/14 16:38
---

## é¢˜ç›®æè¿°

> [!note]- SQL Schema
>
> ```sql
> Create table If Not Exists Activity (player_id int, device_id int, event_date date, games_played int);
> Truncate table Activity;
> insert into Activity (player_id, device_id, event_date, games_played) values ('1', '2', '2016-03-01', '5');
> insert into Activity (player_id, device_id, event_date, games_played) values ('1', '2', '2016-03-02', '6');
> insert into Activity (player_id, device_id, event_date, games_played) values ('2', '3', '2017-06-25', '1');
> insert into Activity (player_id, device_id, event_date, games_played) values ('3', '1', '2016-03-01', '0');
> insert into Activity (player_id, device_id, event_date, games_played) values ('3', '4', '2018-07-03', '5');
> ```

è¡¨ï¼š`Activity`

<pre>
+--------------+---------+
| Column Name  | Type    |
+--------------+---------+
| player_id    | int     |
| device_id    | int     |
| event_date   | date    |
| games_played | int     |
+--------------+---------+
ï¼ˆplayer_idï¼Œevent_dateï¼‰æ˜¯æ­¤è¡¨çš„ä¸»é”®(å…·æœ‰å”¯ä¸€å€¼çš„åˆ—çš„ç»„åˆ)
è¿™å¼ è¡¨æ˜¾ç¤ºäº†æŸäº›æ¸¸æˆçš„ç©å®¶çš„æ´»åŠ¨æƒ…å†µ
æ¯ä¸€è¡Œè¡¨ç¤ºä¸€ä¸ªç©å®¶çš„è®°å½•ï¼Œåœ¨æŸä¸€å¤©ä½¿ç”¨æŸä¸ªè®¾å¤‡æ³¨é”€ä¹‹å‰ï¼Œç™»å½•å¹¶ç©äº†å¾ˆå¤šæ¸¸æˆï¼ˆå¯èƒ½æ˜¯ 0ï¼‰
</pre>

ç©å®¶çš„ **å®‰è£…æ—¥æœŸ** å®šä¹‰ä¸ºè¯¥ç©å®¶çš„ç¬¬ä¸€ä¸ªç™»å½•æ—¥ã€‚

<p>æˆ‘ä»¬å°†æ—¥æœŸ x&nbsp;çš„ <strong>ç¬¬ä¸€å¤©ç•™å­˜ç‡</strong> å®šä¹‰ä¸ºï¼šå‡å®šå®‰è£…æ—¥æœŸä¸º <code>X</code>&nbsp;çš„ç©å®¶çš„æ•°é‡ä¸º <code>N</code>ï¼Œå…¶ä¸­åœ¨ <code>X</code>&nbsp;ä¹‹åçš„ä¸€å¤©é‡æ–°ç™»å½•çš„ç©å®¶æ•°é‡ä¸º <code>M</code>ï¼Œ<code>M/N</code> å°±æ˜¯ç¬¬ä¸€å¤©ç•™å­˜ç‡ï¼Œ<strong>å››èˆäº”å…¥åˆ°å°æ•°ç‚¹åä¸¤ä½</strong>ã€‚</p>
ç¼–å†™è§£å†³æ–¹æ¡ˆï¼ŒæŠ¥å‘Šæ‰€æœ‰å®‰è£…æ—¥æœŸã€å½“å¤©å®‰è£…æ¸¸æˆçš„ç©å®¶æ•°é‡å’Œç©å®¶çš„**ç¬¬ä¸€å¤©ç•™å­˜ç‡**ã€‚

ä»¥ **ä»»æ„é¡ºåº** è¿”å›ç»“æœè¡¨ã€‚

ç»“æœæ ¼å¼å¦‚ä¸‹æ‰€ç¤ºã€‚

**ç¤ºä¾‹ 1ï¼š**

<pre>
<strong>è¾“å…¥ï¼š</strong>
Activity è¡¨ï¼š
+-----------+-----------+------------+--------------+
| player_id | device_id | event_date | games_played |
+-----------+-----------+------------+--------------+
| 1         | 2         | 2016-03-01 | 5            |
| 1         | 2         | 2016-03-02 | 6            |
| 2         | 3         | 2017-06-25 | 1            |
| 3         | 1         | 2016-03-01 | 0            |
| 3         | 4         | 2016-07-03 | 5            |
+-----------+-----------+------------+--------------+
<strong>è¾“å‡ºï¼š</strong>
+------------+----------+----------------+
| install_dt | installs | Day1_retention |
+------------+----------+----------------+
| 2016-03-01 | 2        | 0.50           |
| 2017-06-25 | 1        | 0.00           |
+------------+----------+----------------+
<strong>è§£é‡Šï¼š</strong>
ç©å®¶ 1 å’Œ 3 åœ¨ 2016-03-01 å®‰è£…äº†æ¸¸æˆï¼Œä½†åªæœ‰ç©å®¶ 1 åœ¨ 2016-03-02 é‡æ–°ç™»å½•ï¼Œæ‰€ä»¥ 2016-03-01 çš„ç¬¬ä¸€å¤©ç•™å­˜ç‡æ˜¯ 1/2=0.50
ç©å®¶ 2 åœ¨ 2017-06-25 å®‰è£…äº†æ¸¸æˆï¼Œä½†åœ¨ 2017-06-26 æ²¡æœ‰é‡æ–°ç™»å½•ï¼Œå› æ­¤ 2017-06-25 çš„ç¬¬ä¸€å¤©ç•™å­˜ç‡ä¸º 0/1=0.00
</pre>

## è§£æ³•

### æ–¹æ³•ä¸€

#### è§£é¢˜æ€è·¯

ğŸ·ï¸ Step 1ï¼šæ‰¾å‡ºæ¯ä½ç©å®¶çš„å®‰è£…æ—¥æœŸ

å®‰è£…æ—¥æœŸä¸ºç©å®¶çš„é¦–æ¬¡ç™»å½•æ—¥æœŸï¼ŒæŒ‰ `player_id` åˆ†ç»„å–æœ€å° `event_date` å³å¯ã€‚

```sql
WITH t1 AS (
  SELECT player_id, MIN(event_date) AS install_dt
  FROM Activity
  GROUP BY player_id
)
```

ğŸ·ï¸ Step 2ï¼šåˆ¤æ–­æ¬¡æ—¥æ˜¯å¦ç™»å½•

å°†å®‰è£…æ—¥æœŸè¡¨ `t1` ä¸ `Activity` å·¦è¿æ¥ï¼Œæ¡ä»¶ä¸ºï¼š

- `player_id` ç›¸åŒ
- `event_date = install_dt + 1 å¤©`

è‹¥åŒ¹é…åˆ°è®°å½•ï¼Œåˆ™è¯´æ˜è¯¥ç©å®¶åœ¨æ¬¡æ—¥ç™»å½•ã€‚

```sql
, t2 AS (
  SELECT
    t1.install_dt,
    t1.player_id AS id1, -- å®‰è£…ç”¨æˆ·
    a.player_id AS id2   -- æ¬¡æ—¥ç™»å½•ç”¨æˆ·ï¼ˆå¯èƒ½ä¸º NULLï¼‰
  FROM t1
  LEFT JOIN Activity a
    ON t1.player_id = a.player_id
   AND a.event_date = DATE_ADD(t1.install_dt, INTERVAL 1 DAY)
)
```

ğŸ·ï¸ Step 3ï¼šç»Ÿè®¡å¹¶è®¡ç®—ç•™å­˜ç‡

- å®‰è£…ç”¨æˆ·æ•° = `COUNT(DISTINCT id1)`
- æ¬¡æ—¥ç•™å­˜ç”¨æˆ·æ•° = `COUNT(DISTINCT id2)`
- ç¬¬ä¸€æ—¥ç•™å­˜ç‡ = ç•™å­˜ç”¨æˆ·æ•° Ã· å®‰è£…ç”¨æˆ·æ•°ï¼Œå››èˆäº”å…¥ä¿ç•™ 2 ä½å°æ•°ã€‚

```sql
SELECT
  install_dt,
  COUNT(DISTINCT id1) AS installs,
  ROUND(COUNT(DISTINCT id2) / COUNT(DISTINCT id1), 2) AS Day1_retention
FROM t2
GROUP BY install_dt;
```

#### å®Œæ•´ç­”æ¡ˆ

```sql
WITH t1 AS (
  SELECT player_id, MIN(event_date) AS install_dt
  FROM Activity
  GROUP BY player_id
),
t2 AS (
  SELECT
    t1.install_dt,
    t1.player_id AS id1,
    a.player_id AS id2
  FROM t1
  LEFT JOIN Activity a
    ON t1.player_id = a.player_id
   AND a.event_date = DATE_ADD(t1.install_dt, INTERVAL 1 DAY)
)
SELECT
  install_dt,
  COUNT(DISTINCT id1) AS installs,
  ROUND(COUNT(DISTINCT id2) / COUNT(DISTINCT id1), 2) AS Day1_retention
FROM t2
GROUP BY install_dt;
```
